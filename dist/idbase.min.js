/*! idbase 01-07-2016 */
!function(){window.iDB=window.iDB||{},iDB=window.iDB;var a;iDB["private"]=iDB["private"]||{};var b=[];iDB["private"].MODE_READ_WRITE="readwrite",iDB["private"].MODE_READ="read",iDB["private"].callbackOnDatabaseHit=function(a){b.indexOf(a)>-1||b.push(a)},iDB["private"].getDBInstance=function(c){iDB.helper.callFunctionsWithArgument(b,[c]),a?c.onSuccess(a):iDB["private"].getDB({onSuccess:function(b){a=b,c.onSuccess(a)}})},iDB["private"].getObjectStore=function(a){iDB.helper.callFunctionsWithArgument(b,[]);var c=a.objectStoreName,d=a.mode||"readwrite",e=a.callback;if(!c||!e)throw"Either objectStoreName or callback is not provided";iDB["private"].getDBInstance({onSuccess:function(a){e(a.transaction([c],d).objectStore(c))}})},iDB["private"].readAllData=function(a){var b=a.objectStoreName,c=a.callback,d=[],e={callback:function(a){a.openCursor(null,"prev").onsuccess=function(a){var b=a.target.result;b?(d.push(b.value),b["continue"]()):(console.log("finish all"),c&&c(d))}},mode:"readonly",objectStoreName:b};iDB["private"].getObjectStore(e)}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB["private"]=iDB["private"]||{},iDB.helper=iDB.helper||{},iDB.helper.callFunctionsWithArgument=function(a,b){_.each(a,function(a){a.apply(window,b)})},iDB.helper.objectPropAsArray=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},iDB.helper.eachObjectProperty=function(a,b){if(b)for(var c in a)a.hasOwnProperty(c)&&b(c)},iDB.helper.filterObjectProperties=function(a,b){var c={};return iDB.helper.eachObjectProperty(b,function(b){a[b]&&(c[b]=a[b])}),c},iDB.helper.updateQueryStringParameter=function(a,b,c){var d=new RegExp("([?&])"+b+"=.*?(&|$)","i"),e=-1!==a.indexOf("?")?"&":"?";return a.match(d)?a.replace(d,"$1"+b+"="+c+"$2"):a+e+b+"="+c},iDB.helper.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB["private"]=iDB["private"]||{};var a,b;iDB["private"].getDB=function(c){c.databaseName&&(a=c.databaseName),c.version&&(b=c.version);var d=c.onUpgradeNeeded,e=indexedDB.open(a,b);e.onupgradeneeded=d,e.onsuccess=function(a){console.log("running onsuccess");a.target.result;c.callback&&c.callback()},e.onerror=function(a){console.log(a),onError&&onError(a)}},iDB.init=function(a){var b=function(a){console.log("running onupgradeneeded");var b=a.target.result,c=iDB["private"].getObjectStoresInfo();_.each(c,function(c){var d,e=c.name,f=function(a,b){var c=a.indexNames;_.each(b,function(b){var d=!1;_.each(c,function(a){a===b.name&&(d=!0)}),d||a.createIndex(b.name,b.name,{unique:b.unique})})};b.objectStoreNames.contains(e)?(d=a.currentTarget.transaction.objectStore(e),f(d,c.indexes)):(d=b.createObjectStore(e,{keyPath:c.keyPath.name,autoIncrement:c.keyPath.autoIncrement}),f(d,c.indexes))})};a.onUpgradeNeeded=b,iDB["private"].getDB(a)}}(),function(){window.iDB=window.iDB||{};var a=[];iDB=window.iDB,iDB["private"].getObjectStoresInfo=function(){return a},iDB.registerObjectStore=function(b){_.each(b,function(b){b.keyPath.name=b.keyPath&&b.keyPath.name||"id",b.keyPath.autoIncrement=b.keyPath&&b.keyPath.autoIncrement||!0,a=a||[],a.indexOf(b)<0&&a.push(b)})},iDB.getObjectStoreDetails=function(b){var c;return _.each(a,function(a){a.name===b&&(c=a)}),c},iDB.getKeyPathName=function(a,b){return b?b.keyPath.name:iDB.getObjectStoreDetails(a).keyPath.name},iDB.getObjectStoreIndexes=function(a,b){return b?b.indexes:iDB.getObjectStoreDetails(a).indexes}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB.add=function(a){var b=a.callback,c=a.data,d=0;a.mode=iDB["private"].MODE_READ_WRITE,a.callback=function(e){_.each(c,function(f){var g=e.add(f);g.onsuccess=function(e){iDB["private"].cache.addData(a.objectStoreName,f),++d,console.log("saved to db"),f.id=e.target.result,d===c.length&&b()}})},iDB["private"].getObjectStore(a)}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB.all=function(a){var b=a.objectStoreName;return iDB["private"].cache.isAllDataRetrived(b)?void a.callback(iDB["private"].cache.getAllDataCopy(b)):void iDB["private"].readAllData({objectStoreName:b,callback:function(c){iDB["private"].cache.setAllData({objectStoreName:b,all:c}),a.callback(c)}})}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB["private"]=iDB["private"]||{},iDB["private"].cache={},iDB["private"].cache.data={},iDB["private"].cache.getCache=function(a){return iDB["private"].cache[a]=iDB["private"].cache[a]||{}},iDB["private"].cache.isAllDataRetrived=function(a){return iDB["private"].cache.getCache(a).aDataRetrived},iDB["private"].cache.setAllDataRetrived=function(a){iDB["private"].cache.getCache(a).aDataRetrived=!0},iDB["private"].cache.setAllData=function(a){iDB["private"].cache.setAllDataRetrived(a.objectStoreName);var b=iDB["private"].cache.getCache(a.objectStoreName);b.all=a.all;var c=iDB.getObjectStoreIndexes(a.objectStoreName);_.each(a.all,function(a){iDB["private"].cache.indexData(b,a,c)})},iDB["private"].cache.indexData=function(a,b,c){_.each(c,function(c){a.index=a.index||[];var d=c.name,e=b[d];a.index[d]=a.index[d]||[],a.index[d][e]=a.index[d][e]||[],c.unique?a.index[d][e]=b:a.index[d][e].push(b)})},iDB["private"].cache.removeDataFromIndex=function(a,b,c){_.each(c,function(c){a.index=a.index||[];var d=c.name,e=b[d];if(c.unique)delete a.index[d][e];else{var f=a.index[d][e].indexOf(b);a.index[d][e].splice(f,1)}})},iDB["private"].cache.getIndexedData=function(a,b,c){return iDB["private"].cache.getCache(a).index[b][c]},iDB["private"].cache.getAllData=function(a){return iDB["private"].cache.getCache(a).all},iDB["private"].cache.getAllDataCopy=function(a){var b=[],c=iDB["private"].cache.getCache(a).all;return _.each(c,function(a){b.push(_.clone(a))}),b},iDB["private"].cache.addData=function(a,b){var c=iDB["private"].cache.getAllData(a);if(c){c.push(b);var d=iDB["private"].cache.getCache(a);iDB["private"].cache.indexData(d,b,iDB.getObjectStoreIndexes(a))}},iDB["private"].cache.updateData=function(a){for(var b=a.objectStoreName,c=(iDB.getObjectStoreDetails(b),iDB.getKeyPathName(b)),d=iDB["private"].cache.getAllData(b),e=0;e<d.length;e++){var f=d[e];if(f[c]===a.data[c]){d[e]=a.data;break}}},iDB["private"].cache.deleteData=function(a,b){for(var c=iDB.getObjectStoreDetails(a),d=iDB.getKeyPathName(void 0,c),e=iDB.getObjectStoreIndexes(void 0,c),f=iDB["private"].cache.getAllData(a),g=iDB["private"].cache.getCache(a),h=0;h<f.length;h++){var i=f[h];if(i[d]===b[d]){iDB["private"].cache.removeDataFromIndex(g,b,e),f.splice(h,1);break}}}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB["delete"]=function(a){var b=a.callback,c=0;a.callback=function(d){var e=iDB.getKeyPathName(a.objectsToDelete);_.each(a.objectsToDelete,function(f){var g=f[e],h=d["delete"](g);h.onerror=function(a){throw"could not delete  "+f+a},h.onsuccess=function(d){++c,iDB["private"].cache.deleteData(a.objectStoreName,f),c===a.objectsToDelete.length&&b&&b(!0)}})},iDB["private"].getObjectStore(a)}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB.find=function(a){var b=a.id,c=a.objectStoreName,d=a.callback;iDB["private"].getObjectStore({callback:function(a){var c;try{c=a.get(b)}catch(e){console.error("error"),d(!1)}c.onsuccess=function(a){d(a.target.result)},c.onerror=function(a){console.log(a),d(!1)}},mode:"readonly",objectStoreName:c})}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB.findByIndex=function(a){var b=a.objectStoreName,c=a.callback,d=a.indexName,e=a.indexValue;return iDB["private"].cache.isAllDataRetrived(b)?void c(iDB["private"].cache.getIndexedData(b,d,e)):void iDB["private"].getObjectStore({callback:function(a){var b=a.index(d),e=b.openCursor(value),f=[];e.onsuccess=function(a){var b=a.target.result;b?(f.push(b.value),b["continue"]()):c&&c(f)},e.onerror=function(a){console.log(a),c(!1)}},mode:"readonly",objectStoreName:b})}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB;var a={greaterThan:function(a,b,c){return c>a[b]},equalTo:function(a,b,c){return c==a[b]},lessThan:function(a,b,c){return c<a[b]},lessThanEqualTo:function(a,b,c){return c<=a[b]},greaterThanEqualTo:function(a,b,c){return c>=a[b]},notEqualTo:function(a,b,c){return c!=a[b]}},b=function(b,c){var d=a[c.operator];return d(b,c.property,c.value)};iDB.where=function(a){var c=a.conditions,d=a.callback;_.each(c,function(a){if(!a.hasOwnProperty("property"))throw"Property not found for query "+JSON.stringify(a);if(!a.hasOwnProperty("value"))throw"Value not found for query "+JSON.stringify(a)}),console.log("BaseModel:where valid condition"),a.callback=function(a){var e=[];_.each(a,function(a){var d=!0;_.each(c,function(c,e){if(d=0===e?b(a,c):d||b(a,c))for(;c.and&&(0===e&&(d=b(a,c.and)),d);)c=c.and}),d&&e.push(a)}),console.log("BaseModel:where callback"),d(e)},iDB.all(a)}}();