/*! iDB 15-05-2016 */
!function(){window.iDB=window.iDB||{},iDB=window.iDB;var a;iDB["private"]=iDB["private"]||{},iDB["private"].getDBInstance=function(b){a?b.onSuccess(a):iDB["private"].getDB({onSuccess:function(c){a=c,b.onSuccess(a)}})},iDB["private"].getObjectStore=function(b){var c=b.objectStoreName,d=b.mode||"readwrite",e=b.callback;if(!c||!e)throw"Either objectStoreName or callback is not provided";a?e(a.transaction([c],d).objectStore(c)):iDB["private"].getDBInstance({onSuccess:function(a){e(a.transaction([c],d).objectStore(c))}})},iDB["private"].readAllData=function(a){var b=a.objectStoreName,c=a.callback,d=[];iDB["private"].getObjectStore({callback:function(a){a.openCursor(null,"prev").onsuccess=function(a){var b=a.target.result;b?(d.push(b.value),b["continue"]()):(console.log("finish all"),c&&c(d))}},mode:"readonly",objectStoreName:b})}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB["private"]=iDB["private"]||{};var a,b;iDB["private"].getDB=function(c){c.databaseName&&(a=c.databaseName),c.version&&(b=c.databaseName);var d=c.onUpgradeNeeded,e=c.onSuccess,f=c.onError,g=indexedDB.open(a,b);g.onupgradeneeded=d,g.onsuccess=function(a){console.log("running onsuccess");var b=a.target.result;e&&e(b)},g.onerror=function(a){console.log(a),f&&f(a)}},iDB.init=function(a){var b=function(a){console.log("running onupgradeneeded");var b=a.target.result,c=iDB["private"].getObjectStoresInfo();_.each(c,function(c){var d,e=c.name,f=function(a,b){var c=a.indexNames;_.each(b,function(b){var d=!1;_.each(c,function(a){a===b.name&&(d=!0)}),d||a.createIndex(b.name,b.name,{unique:b.unique})})};b.objectStoreNames.contains(e)?(d=a.currentTarget.transaction.objectStore(e),f(d,c.indexes)):(d=b.createObjectStore(e,{keyPath:c.keyPath.name,autoIncrement:c.keyPath.autoIncrement}),f(d,c.indexes))})};a.onUpgradeNeeded=b,iDB["private"].getDB(a)}}(),function(){window.iDB=window.iDB||{};var a=[];iDB=window.iDB,iDB["private"].getObjectStoresInfo=function(){return a},iDB.registerObjectStore=function(b){_.each(b,function(b){b.keyPath.name=b.keyPath&&b.keyPath.name||"id",b.keyPath.autoIncrement=b.keyPath&&b.keyPath.autoIncrement||!0,a=a||[],a.push(b)})}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB.all=function(a){var b=a.objectStore;a.start,a.end;return iDB["private"].cache.isAllDataRetrived(b)?void b.callback(cache.all):void iDB["private"].readAllData({objectStoreName:b,callback:function(a){iDB["private"].cache.setAllData({objectStoreName:b,all:a})}})}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB["private"]=iDB["private"]||{},iDB["private"].cache={},iDB["private"].cache.data={},iDB["private"].cache.getCache=function(a){return iDB["private"].cache[a]=iDB["private"].cache[a]||{}},iDB["private"].cache.isAllDataRetrived=function(a){return iDB["private"].cache.getCache(a).aDataRetrived},iDB["private"].cache.setAllDataRetrived=function(a){iDB["private"].cache.getCache(a).aDataRetrived=!0},iDB["private"].cache.setAllData=function(a){iDB["private"].cache.setAllDataRetrived(a.objectStoreName),iDB["private"].cache.getCache(a.objectStoreName).all=a.all},iDB["private"].cache.getAllData=function(a){return iDB["private"].cache.getCache(details.objectStoreName).all},iDB["private"].cache.addData=function(a){for(var b=a.objectStoreDetails,c=b.keyPath.name,d=iDB["private"].cache.getAllData(b.name),e=!1,f=0;f<d.length;f++){var g=d[f];if(g[c]===a.data[c]){g[c]=a.data,e=!0;break}}e||d.push(a.data)},iDB["private"].cache.deleteData=function(a){for(var b=a.objectStoreDetails,c=b.keyPath.name,d=iDB["private"].cache.getAllData(b.name),e=0;e<d.length;e++){var f=d[e];if(f[c]===a.data[c]){d.splice(e,1);break}}}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB["delete"]=function(a){var b=a.callback,c=a.id;a.onSuccess=function(a){var d=a["delete"](c);d.onerror=function(a){b&&b(!1)},d.onsuccess=function(a){console.log("item deleted"),b&&b(!0)}},iDB["private"].getObjectStore(a)}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB.find=function(a){var b=a.id,c=a.objectStore,d=a.callback;iDB["private"].getObjectStore({callback:function(a){var c;try{c=a.get(b)}catch(e){console.error("error"),d(!1)}c.onsuccess=function(a){d(a.target.result)},c.onerror=function(a){console.log(a),d(!1)}},mode:"readonly",objectStoreName:c})}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB,iDB.findByIndex=function(a){var b=(a.id,a.objectStore),c=a.callback,d=a.indexName;a.indexValue;iDB["private"].getObjectStore({callback:function(a){var b=a.index(d),e=b.openCursor(value),f=[];e.onsuccess=function(a){var b=a.target.result;b?(f.push(b.value),b["continue"]()):c&&c(f)},e.onerror=function(a){console.log(a),c(!1)}},mode:"readonly",objectStoreName:b})}}(),function(){window.iDB=window.iDB||{},iDB=window.iDB;var a={">":function(a,b,c){return c>a[b]},"==":function(a,b,c){return c==a[b]},"<":function(a,b,c){return c<a[b]},"<=":function(a,b,c){return c<=a[b]},">=":function(a,b,c){return c>=a[b]},"!=":function(a,b,c){return c!=a[b]}},b=function(b,c){var d=a[c.operator];return d(b,c.property,c.value)};iDB.where=function(a){var c=a.conditions,d=a.callback;_.each(c,function(a){if(!a.hasOwnProperty("property"))throw"Property not found for query "+JSON.stringify(a);if(!a.hasOwnProperty("value"))throw"Value not found for query "+JSON.stringify(a)}),console.log("BaseModel:where valid condition"),a.callback=function(a){var e=[];_.each(a,function(a){var d=!0;_.each(c,function(e){var f=(e.property,c.indexOf(e));if(d=0===f?b(a,e):d||b(a,e))for(;e.and&&(0===f&&(d=b(a,e.and)),d);)e=e.and}),d&&e.push(a)}),console.log("BaseModel:where callback"),d(e)},iDB.all(a)}}();